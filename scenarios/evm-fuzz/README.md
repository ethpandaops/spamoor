# EVM Fuzz Contracts

Deploy contracts with randomly generated bytecode to find consensus bugs and stress-test EVM implementations.

## Usage

```bash
spamoor evm-fuzz [flags]
```

## Configuration

### Base Settings (required)
- `--privkey` - Private key of the sending wallet
- `--rpchost` - RPC endpoint(s) to send transactions to

### Volume Control (either -c or -t required)
- `-c, --count` - Total number of contracts to deploy
- `-t, --throughput` - Contracts to deploy per slot (default: 50)
- `--max-pending` - Maximum number of pending transactions (default: 100)

### Transaction Settings
- `--basefee` - Max fee per gas in gwei (default: 20)
- `--tipfee` - Max tip per gas in gwei (default: 2)
- `--gaslimit` - Gas limit per deployment (default: 1000000)
- `--rebroadcast` - Seconds to wait before rebroadcasting (default: 30)
- `--timeout` - Maximum duration to run (e.g. '1h', '30m', '5s')

### Fuzzing Configuration
- `--max-code-size` - Maximum bytecode size in bytes (default: 512)
- `--min-code-size` - Minimum bytecode size in bytes (default: 100)
- `--payload-seed` - Custom hex seed for reproducible fuzzing (e.g. 0x1234abcd)
- `--tx-id-offset` - Start fuzzing from specific transaction ID (default: 0)
- `--fuzz-mode` - Fuzzing mode: 'all' (default), 'opcodes', 'precompiles'

### Wallet Management
- `--max-wallets` - Maximum number of child wallets to use
- `--refill-amount` - ETH amount to fund each child wallet (default: 5)
- `--refill-balance` - Minimum ETH balance before refilling (default: 2)
- `--refill-interval` - Seconds between balance checks (default: 300)

### Client Settings
- `--client-group` - Client group to use for sending transactions

### Debug Options
- `-v, --verbose` - Enable verbose output
- `--log-txs` - Log all submitted transactions
- `--trace` - Enable tracing output

## Features

- **Stack-aware bytecode generation** - Prevents stack underflow/overflow
- **Weighted opcode selection** - Emphasizes interesting/new opcodes
- **Precompile testing** - Generates calls to precompiles
- **Jump pattern fuzzing** - Creates valid and invalid JUMP/JUMPDEST patterns
- **Memory sanitization** - Applies masks to prevent excessive resource usage
- **Deterministic seeding** - Reproducible results with custom seeds
- **Flexible fuzz modes** - Target specific EVM components (opcodes/precompiles)

## Examples

Deploy 1000 fuzzed contracts:
```bash
spamoor evm-fuzz -p "<PRIVKEY>" -h http://rpc-host:8545 -c 1000
```

High-throughput fuzzing for 24 hours:
```bash
spamoor evm-fuzz -p "<PRIVKEY>" -h http://rpc-host:8545 -t 100 --timeout 24h
```

Reproducible fuzzing with custom seed:
```bash
spamoor evm-fuzz -p "<PRIVKEY>" -h http://rpc-host:8545 -c 500 --payload-seed 0x1234abcd
```

Fuzz only EVM opcodes (no precompiles):
```bash
spamoor evm-fuzz -p "<PRIVKEY>" -h http://rpc-host:8545 -c 1000 --fuzz-mode opcodes
```

Fuzz only precompiles with stack setup:
```bash
spamoor evm-fuzz -p "<PRIVKEY>" -h http://rpc-host:8545 -c 500 --fuzz-mode precompiles
```

Large contract fuzzing:
```bash
spamoor evm-fuzz -p "<PRIVKEY>" -h http://rpc-host:8545 -t 10 --min-code-size 1000 --max-code-size 20000
```

## What This Finds

This fuzzer is designed to discover:
- **Consensus differences** between clients
- **Gas calculation bugs** in new or complex opcodes
- **EVM state management issues** 
- **Stack handling problems**
- **Jump/control flow bugs**
- **Memory and storage edge cases**